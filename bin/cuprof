#!/bin/bash

# check if CUPROF_HOME is set
if [ -z ${CU_PROF_HOME} ]; then
    echo "CU_PROF_HOME is not set."
    echo "Please set CU_PROF_HOME to the root directory of this repo."
    exit 1
fi

function help_func()
{
    cat <<EOF
Description: A collection of CUDA application profilers.
Usage:
    -h, --help
        Print this help message.
    -t <tool_name>
        mem_trace: Trace memory access of CUDA kernels.
        app_metric: Collect metrics for CUDA Applications.
        code_check: Check CUDA code for potential issues.
EOF
    exit 0
}

function error_hint()
{
error_message=$1
cat <<EOF
${error_message}
Tip: Use "cuprof -h" for more usage description.
EOF
    exit 1
}

# for debugging
# set -x

while [ -n "$1" ]
do
    arg="$1" ; shift
    case "${arg}" in
        -t)
        export TOOL=$1
        shift
        ;;
        -v)
        export VERBOSE=1
        ;;
        -h)
        help_func
        break
        ;;
        * )
        set -- "${arg}" "$@"
        break
        ;;
    esac
done

EXECUTABLE=$1
ARGS="${*:2}"

if [ -z ${EXECUTABLE} ]
then
    error_hint "Specify the executable to run."
fi

if [ -z ${TOOL} ]
then
    error_hint "Specify tool via -t <tool_name>"
fi


if [ ! -z ${RESULT_DIR} ]
then
    echo "Result directory: ${RESULT_DIR}"
else
    export RESULT_DIR=.
fi

if [ ${EXECUTABLE} == "python" ] || [ ${EXECUTABLE} == "python3" ];
then
    export YOSEMITE_APP_NAME=$(basename $(echo $ARGS | cut -d' ' -f1) .py)
    export TORCH_PROFILE_ENABLED=1
else
    export YOSEMITE_APP_NAME=${EXECUTABLE#./}
    export TORCH_PROFILE_ENABLED=0
fi
echo "${EXECUTABLE} ${ARGS}"

if [ ! -z ${VERBOSE} ]
then
    export OUTPUT_REDIRECT=${RESULT_DIR}/${YOSEMITE_APP_NAME}.cuprof.log
else
    export OUTPUT_REDIRECT=/dev/null
fi

# Profile the application with the specified tool
if [ ${TOOL} == "code_check" ]
then
    export YOSEMITE_TOOL_NAME=code_check
elif [ ${TOOL} == "mem_trace" ]
then
    export YOSEMITE_TOOL_NAME=mem_trace
elif [ ${TOOL} == "app_metric" ]
then
    export YOSEMITE_TOOL_NAME=app_metric
else
    error_hint "Invalid tool name."
fi
echo "Running the ${YOSEMITE_TOOL_NAME} tool for ${YOSEMITE_APP_NAME}..."


# output the command and execution
printf "%-25s: %s\n" "[CUPROF INFO] LD_PRELOAD" \
        "${CU_PROF_HOME}/lib/libcompute_sanitizer.so" > ${OUTPUT_REDIRECT}
printf "%-25s: %s %s\n" "[CUPROF INFO] COMMAND" \
        "${EXECUTABLE}" "${ARGS}" >> ${OUTPUT_REDIRECT}

# Record start time in seconds since epoch
start_time=$(date +%s)
printf "%-25s: %s\n\n" "[CUPROF INFO] START TIME" "$(date)" >> ${OUTPUT_REDIRECT}

# cuprof
LD_PRELOAD_LIB=${CU_PROF_HOME}/lib/libcompute_sanitizer.so
LD_PRELOAD=${LD_PRELOAD_LIB} ${EXECUTABLE} ${ARGS} &>> ${OUTPUT_REDIRECT}

# Record end time and calculate elapsed time
end_time=$(date +%s)
elapsed=$((end_time - start_time))
printf "%-25s: %s\n" "[CUPROF INFO] END TIME" "$(date)" >> ${OUTPUT_REDIRECT}
printf "%-25s: %02d:%02d:%02d\n" "[CUPROF INFO] ELAPSED" \
        $((elapsed/3600)) $((elapsed%3600/60)) $((elapsed%60)) >> ${OUTPUT_REDIRECT}
